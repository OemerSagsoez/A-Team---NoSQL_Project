<html>
	<head>
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" href="css/bootstrap.css">
		
		<script language="javascript" type="text/javascript" src="skripte/jquery-2.1.1.js"></script>
		<script language="javascript" type="text/javascript" src="skripte/communication.js"></script>
		<script language="javascript" type="text/javascript" src="skripte/functions.js"></script>
		<script language="javascript" type="text/javascript" src="skripte/bootstrap.js"></script>
	</head>
	<body>
		<div class="container">
			<nav>
				<ul class="nav nav-tabs">
					<li role="presentation" class="active" id="1LeagueTab"><a onclick="selectLeague(this, 1);">1. Bundesliga</a></li>
					<li role="presentation" id="2LeagueTab"><a onclick="selectLeague(this, 2);">2. Bundesliga</a></li>
				</ul><br>
			</nav>
			<div id="teams"></div><br>
			<!--<nav style="clear:left">
				<ul class="pagination" id="scheduleList">
					<li class="disabled"><a href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>
					<li class="active"><a onclick="selectGameday(this);">1</a></li>
					<li><a href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>
				</ul>
			</nav>-->
			
			<nav class="clearleft">
				<ul class="nav nav-tabs" id="leagueinfolist">
					<li role="presentation" class="active" id="scheduleTab"><a onclick="selectInfo(this, 'schedule');">Spielplan / Ergebnisse</a></li>
					<li role="presentation" id="standingsTab"><a onclick="selectInfo(this, 'standings');">Tabelle</a></li>
				</ul><br>
			</nav>
			<div id="schedule">
				<div class="dropdown marginvertical">
					<button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenuGameday" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
						Dropdown
						<span class="caret"></span>
					</button>
					<ul class="dropdown-menu scrollbox" aria-labelledby="dropdownMenuGameday" id="scheduleList"></ul>
				</div>
				<div id="spielplan"></div>
			</div>
			<div id="standings">
				<table id="standingTable" class="table">
					<thead>
					<tr>
						<td>#</td>
						<td>Team</td>
						<td>S</td>
						<td>N</td>
						<td>U</td>
						<td>Tore</td>
						<td>Gegentore</td>
						<td>+/-</td>
						<td>Pts.</td>
					</tr>
					</thead>
					<tbody id="standingbody">
				</table>
			</div>
			<script>
				var teams = null;
				var schedule = null;
				var currentLeague = 1;
				var currentGameday = 1;
			
				getFromServer("/teams/league/1", showTeams);
				
					
				buildGamedayList();
				getFirstGameday();
				checkForOpenGame();
					
				function buildGamedayList() {
					for(var i = 1; i < 35; i++) {
						var li = jQuery('<li/>', {}).appendTo('#scheduleList');
						jQuery('<a/>', {
							text: i+". Spieltag",
							onclick: "selectGameday(this);"
						}).appendTo(li);
					}
					$("#dropdownMenuGameday").html(currentGameday+". Spieltag <span class='caret'></span>");
				}
					
				function showTeams(data) {
				teams = data;
				$("#teams").empty();
					$.each(data, function(index, value) {
						jQuery('<div/>', {
							width: '40px',
							height: '40px',
							id: value.team_id+'div',
							class: 'left textcenter'
						}).appendTo('#teams');
						
						jQuery('<a/>', {
							href: 'teams.html?team='+value._id,
							id: value.team_id+'link'
						}).appendTo('#'+value.team_id+'div');
			
						jQuery('<img/>', {
							src: 'images/small/'+value.pic_id+'.png',
							width: '30px',
							height: '30px'
						}).mouseover(function(elem) {
							$( this ).animate({ width: "40px", height: "40px" }, 300);
						}).mouseout(function(elem) {
							$( this ).animate({ width: "30px", height: "30px" }, 300);
						}).appendTo('#'+value.team_id+'link');
					});
				}
				
				function selectLeague(elem, league) {
					$("#"+league+"LeagueTab").addClass("active");
					
					if(league == 1) {
						currentLeague = 1;
						$("#2LeagueTab").removeClass("active");
					} else {
						currentLeague = 2;
						$("#1LeagueTab").removeClass("active");
					}
					
					if(league == 1) getFromServer("/teams/league/1", showTeams);
					else getFromServer("/teams/league/2", showTeams);
					getFirstGameday();
					getStandings();
				}
			
				
				function showGameday(data) {
					$("#spielplan").empty();
					$.each(data, function(index, value) {
						var divgame = jQuery('<div/>', {
							class: 'clearleft'
						}).appendTo('#spielplan');
						
						var div = jQuery('<div/>', {
							text: value.date+", "+value.time,
							style: "margin-right:10px;",
							class: 'game left textcenter'
						}).appendTo(divgame);
						
						var div = jQuery('<div/>', {
							width: '40px',
							height: '40px',
							class: 'game left textcenter'
						}).appendTo(divgame);
						
						var a = jQuery('<a/>', {
							href: 'teams.html?team='+value.home,
						}).appendTo(div);
						
						jQuery('<img/>', {
							src: "/images/small/"+picForTeamID(value.home)+".png",
							width: '30px',
							height: '30px'
						}).mouseover(function(elem) {
							$( this ).animate({ width: "40px", height: "40px" }, 300);
						}).mouseout(function(elem) {
							$( this ).animate({ width: "30px", height: "30px" }, 300);
						}).appendTo(a);
						
						jQuery('<div/>', {
							text: " "+value.homegoals+" : "+value.awaygoals+" ",
							class: 'left marginhorizontal'
						}).appendTo(divgame);
						
						var div = jQuery('<div/>', {
							width: '40px',
							height: '40px',
							class: 'game left textcenter'
						}).appendTo(divgame);
						
						var a = jQuery('<a/>', {
							href: 'teams.html?team='+value.away,
						}).appendTo(div);
						
						jQuery('<img/>', {
							src: "/images/small/"+picForTeamID(value.away)+".png",
							width: '30px',
							height: '30px'
						}).mouseover(function(elem) {
							$( this ).animate({ width: "40px", height: "40px" }, 300);
						}).mouseout(function(elem) {
							$( this ).animate({ width: "30px", height: "30px" }, 300);
						}).appendTo(a);
						
					});
				}
				
				function picForTeamID(teamid) {
					for(var i = 0; i < teams.length; i++) {
						if(teams[i]._id == teamid) { return teams[i].pic_id; }
					}
				}
				
				function nameForTeamID(teamid) {
					for(var i = 0; i < teams.length; i++) {
						if(teams[i]._id == teamid) { return teams[i].name; }
					}
				}
				
				function selectGameday(element) {
					//$("#scheduleList li").removeClass("active");
					//$(element).parent().addClass("active");
					var gameday = element.innerHTML.slice(0, element.innerHTML.indexOf("."));
					currentGameday = parseInt(gameday);
					getFromServer("/schedule/"+currentLeague+"/"+gameday, showGameday);
					$("#dropdownMenuGameday").html(currentGameday+". Spieltag <span class='caret'></span>");
				}
				
				function getFirstGameday() {
					currentGameday = 1;
					$("#dropdownMenuGameday").html(currentGameday+". Spieltag <span class='caret'></span>");
					getFromServer("/schedule/"+currentLeague+"/1", showGameday);
				}
				
				function checkForOpenGame() {
					getFromServer("/schedule", function(data) {
						var now = new Date();
						$.each(data, function(index, value) {
							var date = value.date.split(".");
							var time = value.time.split(":");
							var gametime = new Date(date[2], date[1], date[0], time[0], time[1], 0);
							if(now > gametime && (typeof value.played == "undefined" || value.played != "true")) {
								
								//simulateGame(value);
								
							}
							/*if(now < gametime) {
								var json = '{"homegoals": "-", "awaygoals": "-"}';
								putToServer("schedule/"+value._id, json, function() {})
							}*/
						});
						
						
					});
				}
				
				function simulateGame(game) {
					var hometeam, awayteam = null;
					getFromServer("/squad/"+game.home, function(data) {
						hometeam = data;
					});
					getFromServer("/squad/"+game.away, function(data) {
						awayteam = data;
					});
					var home = Math.round(Math.random() * (5 - 0)) + 0;
					var away = Math.round(Math.random() * (5 - 0)) + 0;
					var goals = new Array();
					for(var i = 0; i < home; i++) {
						var player = Math.round(Math.random() * (hometeam.length - 0)) + 0;
						var json = '{ $inc: { goals: 1} }';
						goals.push(hometeam[player]);
						putToServer("squad/"+hometeam[player], json, function() {})
					}
					for(var i = 0; i < away; i++) {
						var player = Math.round(Math.random() * (awayteam.length - 0)) + 0;
						var json = '{ $inc: { goals: 1} }';
						goals.push(awayteam[player]);
						putToServer("squad/"+awayteam[player], json, function() {})
					}
					var json = '{"homegoals": "'+home+'", "awaygoals": "'+away+'", "goals": "'+goals+'"}';
					putToServer("schedule/"+game._id, json, function() {});
				}
				
				function selectInfo(element, data) {
					$("#leagueinfolist li").removeClass("active");
					$(element).parent().addClass("active");
				
					if(data == "schedule") {
						$("#schedule").css("display", "inline");
						$("#standings").css("display", "none");
						getFirstGameday();
					} else if(data == "standings") {
						$("#schedule").css("display", "none");
						$("#standings").css("display", "inline");
						getStandings();
					}
				}
				
				function getStandings() {
					getFromServer("/schedule/"+currentLeague, function(data) {
						var table = new Array();
						$.each(teams, function(index, value) {
							table[value._id] = {
								win: 0,
								tie: 0,
								loss: 0,
								goals:0,
								goalsagainst: 0,
								points: 0
							};
						});
						var now = new Date();
						$.each(data, function(index, value) {
							//console.log(value);
							var date = value.date.split(".");
							var time = value.time.split(":");
							var gametime = new Date(date[2], date[1], date[0], time[0], time[1], 0);
							
							if(now > gametime && (typeof value.played == "undefined" || value.played != "true")) {
								table[value.home]["goals"] += parseInt(value.homegoals);
								table[value.home]["goalsagainst"] += parseInt(value.awaygoals);
								table[value.away]["goals"] += parseInt(value.awaygoals);
								table[value.away]["goalsagainst"] += parseInt(value.homegoals);
								if(value.homegoals > value.awaygoals) {
									table[value.home]["win"]++;
									table[value.home]["points"]+=3;
									table[value.away]["loss"]++;
								} else if(value.homegoals < value.awaygoals) {
									table[value.home]["loss"]++;
									table[value.away]["win"]++;
									table[value.away]["points"]+=3;
								} else {
									table[value.home]["tie"]++;
									table[value.away]["tie"]++;
									table[value.home]["points"]++;
									table[value.away]["points"]++;
								}
							}
						});
						table = sortTable(table);
						showTable(table);
					});
				}
				
				function sortTable(table) {
					var rank = new Array();
					var i = 0;
					$.each(teams, function(index, value){
						rank[i] = table[value["_id"]];
						rank[i]["id"] = value["_id"];
						i++;
					});
					var h = null;
					for (i = 0; i < 18-1; i++) {
						for (j = i + 1; j < 18; j++) {
							if (teamIsBetter(rank[j], rank[i])) {
								h = rank[i];
								rank[i] = rank[j];
								rank[j] = h;
							} else if ((rank[j]["points"] == rank[i]["points"]) && (rank[j]["goals"] - rank[j]["goalsagains"] > rank[i]["goals"] - rank[i]["goalsagains"])) {
								h = rank[i];
								rank[i] = rank[j];
								rank[j] = h;
							}
						}
					}
					return rank;
				}
				
				function teamIsBetter(firstteam, secondteam) {
					if(firstteam["points"] > secondteam["points"]) {
						return true;
					} else if((firstteam["points"] == secondteam["points"]) &&
							(parseInt(firstteam["goals"])-parseInt(firstteam["goalsagainst"]) > parseInt(secondteam["goals"])-parseInt(secondteam["goalsagainst"]))) {
						return true;
					}else if((firstteam["points"] == secondteam["points"]) &&
							(parseInt(firstteam["goals"])-parseInt(firstteam["goalsagainst"]) == parseInt(secondteam["goals"])-parseInt(secondteam["goalsagainst"])) &&
							(parseInt(firstteam["goals"]) > parseInt(secondteam["goals"]))) {
						return true;
					} else {
						return false
					}
				}
				
				function showTable(table) {
					$("#standingbody").empty();
					$.each(table, function(index, value) {
						var tr = jQuery('<tr/>', {}).appendTo("#standingbody");
						jQuery('<td/>', {
							text: index+1
						}).appendTo(tr);
						
						var td = jQuery('<td/>', {}).appendTo(tr);
						var a = jQuery('<a/>', {
							href: 'teams.html?team='+value.id,
						}).appendTo(td);
						
						jQuery('<img/>', {
							src: "/images/small/"+picForTeamID(value.id)+".png",
							width: '30px',
							height: '30px'
						}).appendTo(a);
						
						jQuery('<td/>', {
							text: value.win
						}).appendTo(tr);
						jQuery('<td/>', {
							text: value.loss
						}).appendTo(tr);
						jQuery('<td/>', {
							text: value.tie
						}).appendTo(tr);
						jQuery('<td/>', {
							text: value.goals
						}).appendTo(tr);
						jQuery('<td/>', {
							text: value.goalsagainst
						}).appendTo(tr);
						jQuery('<td/>', {
							text: value.goals-value.goalsagainst
						}).appendTo(tr);
						jQuery('<td/>', {
							text: value.points
						}).appendTo(tr);
						
					});
				}
			</script>
		</div>
	</body>
</html>